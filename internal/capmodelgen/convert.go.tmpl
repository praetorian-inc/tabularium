// Code generated by capmodelgen; DO NOT EDIT.

package capmodel

import (
	"encoding/json"

	"github.com/praetorian-inc/tabularium/pkg/model/model"
	"github.com/praetorian-inc/tabularium/pkg/registry"
)

func init() {
{{- range .}}
	registry.Registry.MustRegisterConverter("{{.Name}}", convert{{.Name}})
{{- end}}
}

{{range .}}
func convert{{.Name}}(data []byte) (registry.Model, error) {
	var raw map[string]json.RawMessage
	if err := json.Unmarshal(data, &raw); err != nil {
		return nil, err
	}

	remapped := make(map[string]json.RawMessage, len(raw))
	for k, v := range raw {
		switch k {
{{- range $f := .Fields}}
		case "{{$f.JSONName}}":
{{- range $f.SourceJSONNames}}
			remapped["{{.}}"] = v
{{- end}}
{{- end}}
{{- if .Parent}}
		case "{{.Parent.JSONName}}":
			// handled below
{{- end}}
		default:
			remapped[k] = v
		}
	}

	b, err := json.Marshal(remapped)
	if err != nil {
		return nil, err
	}

{{- if .Parent}}

	var parentModel registry.Model
	if parentRaw, ok := raw["{{.Parent.JSONName}}"]; ok {
		parentModel, err = registry.Registry.Convert("{{.Parent.EmbedType}}", parentRaw)
		if err != nil {
			return nil, err
		}
	}

	var result model.{{.SourceTypeName}}
	result.Defaulted()
	if err := json.Unmarshal(b, &result); err != nil {
		return nil, err
	}
{{- if .Parent.Wrap}}
	if parentModel != nil {
		result.{{.Parent.SourceFieldName}} = model.NewGraphModelWrapper(parentModel.(model.GraphModel))
	}
{{- else}}
	if parentModel != nil {
		result.{{.Parent.SourceFieldName}} = parentModel.({{.Parent.SourceGoType}})
	}
{{- end}}
	if err := registry.CallHooks(&result); err != nil {
		return nil, err
	}
{{- else}}

	var result model.{{.SourceTypeName}}
	if err := registry.UnmarshalModel(b, &result); err != nil {
		return nil, err
	}
{{- end}}

	return &result, nil
}

{{end}}
